<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Citibike NYC: A Story of Growth & Environmental Impact</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --citibike-blue: #0099FF;
            --citibike-dark-blue: #0066CC;
            --citibike-light-blue: #33AAFF;
            --citibike-red: #E31E24;
            --citibike-orange: #FF6B35;
            --citibike-gray: #6C757D;
            --citibike-light-gray: #F8F9FA;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            color: #333;
            background: linear-gradient(135deg, var(--citibike-light-blue) 0%, var(--citibike-blue) 100%);
            min-height: 100vh;
            margin: 0;
            padding: 0;
        }

        .container {
            max-width: 1400px;
            height: 100vh;
            margin: 0 auto;
            padding: 0;
            display: grid;
            grid-template-rows: auto 1fr;
            overflow: hidden;
            background: #f5f5f5;
        }

        .hero {
            text-align: center;
            color: var(--citibike-blue);
            padding: 30px 20px;
            background: white;
            box-shadow: 0 4px 20px rgba(0,153,255,0.2);
        }

        .hero h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            opacity: 0;
            animation: fadeInUp 1s ease-out forwards;
        }

        .hero p {
            font-size: 1.1em;
            opacity: 0;
            animation: fadeInUp 1s ease-out 0.3s forwards;
        }

        .main-content {
            display: grid;
            grid-template-columns: 450px 1fr;
            gap: 30px;
            padding: 30px;
            height: 100%;
            overflow: hidden;
            background: #f5f5f5;
        }

        .left-panel {
            display: grid;
            grid-template-rows: 1fr 1fr 1fr 1fr;
            gap: 15px;
            height: 100%;
            min-height: 0;
        }

        .insight-card {
            background: white;
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            position: relative;
            cursor: pointer;
            transition: transform 0.3s ease;
        }

        .insight-card:hover {
            transform: translateY(-5px);
        }

        .insight-number {
            font-size: 2em;
            font-weight: bold;
            color: var(--citibike-red);
            margin-bottom: 10px;
        }

        .insight-title {
            font-size: 1.1em;
            font-weight: bold;
            color: var(--citibike-blue);
            margin-bottom: 8px;
            line-height: 1.2;
        }

        .insight-summary {
            font-size: 0.85em;
            color: #666;
            line-height: 1.3;
            flex: 1;
        }

        .insight-icon {
            position: absolute;
            top: 15px;
            right: 50px;
            font-size: 1.5em;
        }

        .right-panel {
            display: flex;
            flex-direction: column;
            height: 100%;
        }

        .stats-section {
            background: white;
            padding: 15px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            display: flex;
            flex-direction: column;
            height: 120px;
            overflow: hidden;
        }

        .stats-section h2 {
            margin-bottom: 10px;
            font-size: 1.2em;
            color: #333;
            text-align: center;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 8px;
            flex: 1;
        }

        .stat-card {
            background: transparent;
            padding: 8px;
            border-radius: 10px;
            text-align: center;
            opacity: 0;
            animation: fadeInUp 0.8s ease-out forwards;
        }

        .stat-number {
            font-size: 1.2em;
            font-weight: bold;
            color: #667eea;
            margin-bottom: 3px;
            line-height: 1.1;
        }

        .stat-label {
            font-size: 0.7em;
            color: #666;
            line-height: 1.1;
        }

        .chart-container {
            background: white;
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            opacity: 0;
            animation: fadeInUp 0.8s ease-out 0.5s forwards;
            display: flex;
            flex-direction: column;
            flex: 1;
            min-height: 0;
        }

        .chart-title {
            font-size: 1.4em;
            margin-bottom: 15px;
            color: #333;
            text-align: center;
        }

        .controls {
            text-align: center;
            margin-bottom: 15px;
        }

        .btn {
            background: #667eea;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 0.9em;
            margin: 0 5px;
            transition: all 0.3s ease;
        }

        .btn:hover {
            background: #5a6fd8;
            transform: translateY(-2px);
        }

        .btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        #growthChart {
            flex: 1;
            min-height: 0;
        }

        #map {
            flex: 1;
            border-radius: 10px;
            position: relative;
        }

        .grayscale-map {
            filter: grayscale(100%) contrast(1.2);
        }

        .map-animation-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            pointer-events: none;
            z-index: 1000;
            border-radius: 10px;
        }

        .environmental-impact {
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
            color: white;
            padding: 10px;
            border-radius: 15px;
            text-align: center;
            display: flex;
            flex-direction: column;
            height: 120px;
            overflow: hidden;
        }

        .environmental-impact h2 {
            margin-bottom: 5px;
            font-size: 1.1em;
        }

        .environmental-impact p {
            margin-bottom: 8px;
            font-size: 0.75em;
        }

        .impact-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 6px;
            flex: 1;
            min-height: 0;
        }

        .impact-number {
            font-size: 0.8em;
            font-weight: bold;
            margin-bottom: 1px;
            line-height: 1;
        }

        .impact-icon {
            font-size: 0.9em;
            margin-bottom: 2px;
        }

        .impact-item {
            text-align: center;
            font-size: 0.55em;
            line-height: 1;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }

        .modal-content {
            background-color: white;
            margin: 2% auto;
            padding: 30px;
            border-radius: 15px;
            width: 90%;
            max-width: 900px;
            max-height: 85vh;
            overflow-y: auto;
            position: relative;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }

        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            position: absolute;
            right: 20px;
            top: 15px;
        }

        .close:hover {
            color: #000;
        }

        .expandable {
            cursor: pointer;
            position: relative;
        }

        .expand-hint {
            position: absolute;
            top: 10px;
            right: 15px;
            font-size: 1.2em;
            opacity: 0.8;
            cursor: pointer;
        }

        .tooltip {
            position: absolute;
            background: rgba(0,0,0,0.8);
            color: white;
            padding: 10px;
            border-radius: 5px;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.3s;
        }

        @keyframes fadeInUp {
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes countUp {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .bar {
            transition: all 0.3s ease;
        }

        .bar:hover {
            opacity: 0.8;
        }

        .line {
            fill: none;
            stroke: #667eea;
            stroke-width: 3;
        }

        .area {
            fill: url(#gradient);
            opacity: 0.7;
        }

        @media (prefers-reduced-motion: reduce) {
            * {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
            }
        }

        .bike-animation {
            position: relative;
            width: 100%;
            height: 100%;
            border-radius: 15px;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
        }

        .citibike-image {
            position: absolute;
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 15px;
            opacity: 0;
            transition: opacity 1s ease-in-out;
        }

        .citibike-image.active {
            opacity: 1;
        }

        .image-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.3);
            border-radius: 10px;
        }

        .citibike-logo {
            position: relative;
            z-index: 10;
            font-size: 2.5em;
            font-weight: bold;
            color: white;
            margin-bottom: 30px;
            text-shadow: 2px 2px 8px rgba(0,0,0,0.8);
            animation: logoGlow 3s ease-in-out infinite;
        }

        @keyframes logoGlow {
            0%, 100% { text-shadow: 2px 2px 8px rgba(0,0,0,0.8); }
            50% { text-shadow: 2px 2px 20px rgba(255,255,255,0.5); }
        }

        .stats-overlay {
            position: absolute;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            text-align: center;
            color: white;
            font-size: 1.1em;
            background: rgba(0,0,0,0.6);
            padding: 15px 25px;
            border-radius: 25px;
            backdrop-filter: blur(10px);
            z-index: 10;
        }

        .click-hint {
            position: absolute;
            top: 20px;
            right: 20px;
            color: rgba(255,255,255,0.9);
            font-size: 0.9em;
            animation: pulse 2s infinite;
            background: rgba(0,0,0,0.5);
            padding: 8px 15px;
            border-radius: 20px;
            z-index: 10;
        }

        @keyframes pulse {
            0%, 100% { opacity: 0.8; transform: scale(1); }
            50% { opacity: 0.4; transform: scale(1.05); }
        }

        .chart-container {
            border-radius: 15px;
            opacity: 0;
            animation: fadeInUp 0.8s ease-out 0.5s forwards;
            display: flex;
            flex-direction: column;
            flex: 1;
            min-height: 0;
            overflow: hidden;
        }

        #rightPanelContent {
            flex: 1;
            min-height: 0;
            border-radius: 15px;
            overflow: hidden;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="hero">
            <div style="display: flex; align-items: center; justify-content: center; gap: 15px; margin-bottom: 10px;">
                <img src="Citi_Bike_logo.svg" alt="Citibike Logo" style="height: 50px; width: auto;">
                <h1 style="margin: 0; font-size: 2.2em; margin-top: 12px;">Sustainability Impact</h1>
            </div>
        </div>

        <div class="main-content">
            <div class="left-panel">
                <div class="insight-card" onclick="showInsight(1)">
                    <div class="insight-number">#1</div>
                    <div class="insight-title">Scale of Individual Choices</div>
                    <div class="insight-summary">184M individual bike rides = removing 15,000+ cars from roads permanently</div>
                    <div class="insight-icon">üéØ</div>
                    <div class="expand-hint">‚§¢</div>
                </div>

                <div class="insight-card" onclick="showInsight(2)">
                    <div class="insight-number">#2</div>
                    <div class="insight-title">Convenience Drives Sustainability</div>
                    <div class="insight-summary">People choose bikes for convenience, environment benefits automatically</div>
                    <div class="insight-icon">üö¥‚Äç‚ôÇÔ∏è</div>
                    <div class="expand-hint">‚§¢</div>
                </div>

                <div class="insight-card" onclick="showInsight(3)">
                    <div class="insight-number">#3</div>
                    <div class="insight-title">Peak Hours Reveal True Motivation</div>
                    <div class="insight-summary">Rush hour patterns prove it's about commuting efficiency, not recreation</div>
                    <div class="insight-icon">‚è∞</div>
                    <div class="expand-hint">‚§¢</div>
                </div>

                <div class="insight-card" onclick="showInsight(4)">
                    <div class="insight-number">#4</div>
                    <div class="insight-title">Infrastructure Creates Behavior Change</div>
                    <div class="insight-summary">Build bike lanes and stations ‚Üí people automatically choose sustainable transport</div>
                    <div class="insight-icon">üõ§Ô∏è</div>
                    <div class="expand-hint">‚§¢</div>
                </div>
            </div>

            <div class="right-panel">
                <div class="chart-container">
                    <div id="rightPanelContent">
                        <div class="bike-animation">
                            <img src="4_how_to_ride.webp" class="citibike-image active" alt="How to ride">
                            <img src="EasyRider-Side_01-email_0000000000.webp" class="citibike-image" alt="Easy Rider">
                            <img src="5_park_docked.webp" class="citibike-image" alt="Park docked">
                            
                            <div class="image-overlay"></div>
                            
                            <div class="stats-overlay">
                                <div style="font-size: 0.9em; opacity: 0.9;">‚Üê Select an insight to explore the data</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="tooltip" id="tooltip"></div>

    <!-- Insight 1 Modal -->
    <div id="insight1Modal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('insight1Modal')">&times;</span>
            <h2>üéØ Scale of Individual Choices</h2>
            
            <div id="accumulationViz" style="background: #f8f9fa; border-radius: 10px; padding: 15px; margin: 15px 0; min-height: 320px;">
                <!-- Animation will be inserted here -->
            </div>
            
            <div style="padding: 15px; line-height: 1.4;">
                <h3 style="margin-top: 0;">The Numbers:</h3>
                <ul style="margin: 10px 0;">
                    <li><strong>184.5 million</strong> bike trips analyzed</li>
                    <li><strong>221 million</strong> miles of car travel replaced</li>
                    <li><strong>126,000 tons</strong> of CO‚ÇÇ emissions avoided</li>
                </ul>
                
                <div style="background: #f0f8ff; padding: 12px; border-radius: 8px; margin: 15px 0;">
                    <strong>üí° Key Takeaway:</strong> Individual sustainable choices become powerful when they scale across entire populations.
                </div>
            </div>
        </div>
    </div>

    <!-- Insight 2 Modal -->
    <div id="insight2Modal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('insight2Modal')">&times;</span>
            <h2>üö¥‚Äç‚ôÇÔ∏è Convenience Drives Sustainability</h2>
            
            <div id="weatherViz" style="background: #f8f9fa; border-radius: 10px; padding: 20px; margin: 20px 0; min-height: 320px;">
                <!-- Animation will be inserted here -->
            </div>
            
            <div style="padding: 20px; line-height: 1.6;">
                <h3>What This Reveals:</h3>
                <p>People don't choose bikes to "save the environment" - they choose them because they're convenient, fast, and pleasant. The environmental benefit happens automatically when sustainable options are the easy choice.</p>
                
                <div style="background: #f0f8ff; padding: 15px; border-radius: 10px; margin: 20px 0;">
                    <strong>üí° Key Takeaway:</strong> The most effective environmental solutions work WITH human nature, not against it.
                </div>
            </div>
        </div>
    </div>

    <!-- Insight 3 Modal -->
    <div id="insight3Modal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('insight3Modal')">&times;</span>
            <h2>‚è∞ Peak Hours Reveal True Motivation</h2>
            
            <div id="peakHoursViz" style="background: #f8f9fa; border-radius: 10px; padding: 20px; margin: 20px 0; min-height: 320px;">
                <!-- Animation will be inserted here -->
            </div>
            
            <div style="padding: 20px; line-height: 1.6;">
                <h3>What This Reveals:</h3>
                <p>Rush hour spikes at 8AM and 5PM prove people use Citibike for practical commuting, not recreational riding. The sharp peaks show this is about getting to work efficiently, not environmental activism or leisure.</p>
                
                <div style="background: #f0f8ff; padding: 15px; border-radius: 10px; margin: 20px 0;">
                    <strong>üí° Key Takeaway:</strong> When sustainable transport serves real needs (fast commuting), adoption happens naturally.
                </div>
            </div>
        </div>
    </div>

    <!-- Insight 4 Modal -->
    <div id="insight4Modal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('insight4Modal')">&times;</span>
            <h2>üõ§Ô∏è Infrastructure Creates Behavior Change</h2>
            
            <div id="infrastructureViz" style="background: #f8f9fa; border-radius: 10px; padding: 20px; margin: 20px 0; min-height: 420px;">
                <!-- Map animation will be inserted here -->
            </div>
            
            <div style="padding: 20px; line-height: 1.6;">
                <h3>The Infrastructure Effect:</h3>
                <p>Watch how bike lane expansion directly correlates with ridership growth. Each new route enables thousands more sustainable trips.</p>
                
                <div style="background: #f0f8ff; padding: 15px; border-radius: 10px; margin: 20px 0;">
                    <strong>üí° Key Takeaway:</strong> Build the infrastructure, and sustainable behavior follows automatically. 184M trips were enabled by strategic bike lane expansion.
                </div>
            </div>
        </div>
    </div>

    <script>
        let dashboardData = null;
        let currentChart = 'yearly';
        let animationInProgress = false;

        // Load data and initialize dashboard
        async function loadData() {
            try {
                const response = await fetch('citibike_dashboard_data.json');
                dashboardData = await response.json();
                initializeDashboard();
            } catch (error) {
                console.error('Error loading data:', error);
                // Fallback with sample data
                dashboardData = createSampleData();
                initializeDashboard();
            }
        }

        function createSampleData() {
            return {
                yearly_stats: {
                    "2013": { total_trips: 6000000, co2_saved_lbs: 6440000, cars_equivalent: 600 },
                    "2014": { total_trips: 8000000, co2_saved_lbs: 8586000, cars_equivalent: 800 },
                    "2015": { total_trips: 10000000, co2_saved_lbs: 10732000, cars_equivalent: 1000 },
                    "2016": { total_trips: 14000000, co2_saved_lbs: 15025000, cars_equivalent: 1400 },
                    "2017": { total_trips: 16000000, co2_saved_lbs: 17171000, cars_equivalent: 1600 },
                    "2018": { total_trips: 17000000, co2_saved_lbs: 18244000, cars_equivalent: 1700 },
                    "2019": { total_trips: 20000000, co2_saved_lbs: 21464000, cars_equivalent: 2000 },
                    "2020": { total_trips: 12000000, co2_saved_lbs: 12878000, cars_equivalent: 1200 },
                    "2021": { total_trips: 15000000, co2_saved_lbs: 16098000, cars_equivalent: 1500 }
                },
                summary: {
                    total_trips_all_time: 118000000,
                    years_active: 9,
                    peak_year: "2019",
                    total_co2_saved: 126638000
                }
            };
        }

        function initializeDashboard() {
            populateStats();
            createYearlyChart();
            createMap();
            populateEnvironmentalImpact();
        }

        function populateStats() {
            const statsGrid = document.getElementById('statsGrid');
            const stats = [
                {
                    number: formatNumber(dashboardData.summary.total_trips_all_time),
                    label: 'Total Rides'
                },
                {
                    number: dashboardData.summary.years_active,
                    label: 'Years Active'
                },
                {
                    number: formatNumber(Math.round(dashboardData.summary.total_co2_saved)),
                    label: 'lbs CO‚ÇÇ Saved'
                },
                {
                    number: dashboardData.summary.peak_year,
                    label: 'Peak Year'
                }
            ];

            statsGrid.innerHTML = stats.map(stat => `
                <div class="stat-card">
                    <div class="stat-number">${stat.number}</div>
                    <div class="stat-label">${stat.label}</div>
                </div>
            `).join('');

            // Animate numbers
            setTimeout(() => {
                animateNumbers();
            }, 500);
        }

        function animateNumbers() {
            const statNumbers = document.querySelectorAll('.stat-number');
            statNumbers.forEach((element, index) => {
                if (index === 3) return; // Skip year animation
                
                const finalValue = element.textContent.replace(/,/g, '');
                const numericValue = parseInt(finalValue);
                if (isNaN(numericValue)) return;

                let current = 0;
                const increment = numericValue / 50;
                const timer = setInterval(() => {
                    current += increment;
                    if (current >= numericValue) {
                        current = numericValue;
                        clearInterval(timer);
                    }
                    element.textContent = formatNumber(Math.floor(current));
                }, 30);
            });
        }

        function createYearlyChart() {
            const container = d3.select('#growthChart');
            container.selectAll('*').remove();

            const containerNode = container.node();
            const width = containerNode.clientWidth - 40;
            const height = containerNode.clientHeight - 40;
            const margin = { top: 20, right: 30, bottom: 40, left: 70 };
            const chartWidth = width - margin.left - margin.right;
            const chartHeight = height - margin.top - margin.bottom;

            const svg = container.append('svg')
                .attr('width', width)
                .attr('height', height);

            const g = svg.append('g')
                .attr('transform', `translate(${margin.left},${margin.top})`);

            // Create gradient
            const defs = svg.append('defs');
            const gradient = defs.append('linearGradient')
                .attr('id', 'gradient')
                .attr('gradientUnits', 'userSpaceOnUse')
                .attr('x1', 0).attr('y1', chartHeight)
                .attr('x2', 0).attr('y2', 0);
            
            gradient.append('stop')
                .attr('offset', '0%')
                .attr('stop-color', '#667eea')
                .attr('stop-opacity', 0.1);
            
            gradient.append('stop')
                .attr('offset', '100%')
                .attr('stop-color', '#667eea')
                .attr('stop-opacity', 0.8);

            const data = Object.entries(dashboardData.yearly_stats)
                .map(([year, stats]) => ({
                    year: parseInt(year),
                    trips: stats.total_trips
                }))
                .sort((a, b) => a.year - b.year);

            const xScale = d3.scaleLinear()
                .domain(d3.extent(data, d => d.year))
                .range([0, chartWidth]);

            const yScale = d3.scaleLinear()
                .domain([0, d3.max(data, d => d.trips)])
                .range([chartHeight, 0]);

            // Create area
            const area = d3.area()
                .x(d => xScale(d.year))
                .y0(chartHeight)
                .y1(d => yScale(d.trips))
                .curve(d3.curveMonotoneX);

            // Create line
            const line = d3.line()
                .x(d => xScale(d.year))
                .y(d => yScale(d.trips))
                .curve(d3.curveMonotoneX);

            // Add axes
            g.append('g')
                .attr('transform', `translate(0,${chartHeight})`)
                .call(d3.axisBottom(xScale).tickFormat(d3.format('d')));

            g.append('g')
                .call(d3.axisLeft(yScale).tickFormat(d => formatNumber(d)));

            // Add area with animation
            const areaPath = g.append('path')
                .datum(data)
                .attr('class', 'area')
                .attr('d', area);

            // Add line with animation
            const linePath = g.append('path')
                .datum(data)
                .attr('class', 'line')
                .attr('d', line);

            // Animate the chart
            if (!animationInProgress) {
                const totalLength = linePath.node().getTotalLength();
                
                linePath
                    .attr('stroke-dasharray', totalLength + ' ' + totalLength)
                    .attr('stroke-dashoffset', totalLength)
                    .transition()
                    .duration(2000)
                    .ease(d3.easeLinear)
                    .attr('stroke-dashoffset', 0);

                areaPath
                    .style('opacity', 0)
                    .transition()
                    .duration(2000)
                    .style('opacity', 0.7);
            }

            // Add dots
            g.selectAll('.dot')
                .data(data)
                .enter().append('circle')
                .attr('class', 'dot')
                .attr('cx', d => xScale(d.year))
                .attr('cy', d => yScale(d.trips))
                .attr('r', 5)
                .attr('fill', '#667eea')
                .style('opacity', 0)
                .transition()
                .delay((d, i) => i * 200)
                .duration(500)
                .style('opacity', 1)
                .on('end', function() {
                    d3.select(this)
                        .on('mouseover', function(event, d) {
                            showTooltip(event, `${d.year}: ${formatNumber(d.trips)} rides`);
                        })
                        .on('mouseout', hideTooltip);
                });

            currentChart = 'yearly';
        }

        function showYearlyChart() {
            if (currentChart !== 'yearly') {
                createYearlyChart();
            }
        }

        function showMonthlyChart() {
            if (currentChart !== 'monthly') {
                createMonthlyTrendChart();
            }
        }

        function createMonthlyTrendChart() {
            const container = d3.select('#growthChart');
            container.selectAll('*').remove();

            const margin = { top: 20, right: 30, bottom: 40, left: 70 };
            const width = 800 - margin.left - margin.right;
            const height = 400 - margin.top - margin.bottom;

            const svg = container.append('svg')
                .attr('width', width + margin.left + margin.right)
                .attr('height', height + margin.top + margin.bottom);

            const g = svg.append('g')
                .attr('transform', `translate(${margin.left},${margin.top})`);

            // Sample monthly data (simplified)
            const monthlyData = [];
            for (let year = 2013; year <= 2021; year++) {
                for (let month = 1; month <= 12; month++) {
                    const baseTrips = dashboardData.yearly_stats[year]?.total_trips || 0;
                    const seasonalFactor = 0.5 + 0.5 * Math.sin((month - 3) * Math.PI / 6);
                    monthlyData.push({
                        date: new Date(year, month - 1),
                        trips: Math.round(baseTrips * seasonalFactor / 12)
                    });
                }
            }

            const xScale = d3.scaleTime()
                .domain(d3.extent(monthlyData, d => d.date))
                .range([0, width]);

            const yScale = d3.scaleLinear()
                .domain([0, d3.max(monthlyData, d => d.trips)])
                .range([height, 0]);

            const line = d3.line()
                .x(d => xScale(d.date))
                .y(d => yScale(d.trips))
                .curve(d3.curveMonotoneX);

            // Add axes
            g.append('g')
                .attr('transform', `translate(0,${height})`)
                .call(d3.axisBottom(xScale));

            g.append('g')
                .call(d3.axisLeft(yScale).tickFormat(d => formatNumber(d)));

            // Add line
            g.append('path')
                .datum(monthlyData)
                .attr('class', 'line')
                .attr('d', line);

            currentChart = 'monthly';
        }

        function replayAnimation() {
            if (animationInProgress) return;
            
            animationInProgress = true;
            if (currentChart === 'yearly') {
                createYearlyChart();
            } else {
                createMonthlyTrendChart();
            }
            
            setTimeout(() => {
                animationInProgress = false;
            }, 3000);
        }

        function createMap() {
            const map = L.map('map').setView([40.7589, -73.9851], 12);
            
            // Grayscale tile layer
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '¬© OpenStreetMap contributors',
                className: 'grayscale-map'
            }).addTo(map);

            // Load and display bike routes with grayscale styling
            fetch('New York City Bike Routes_20250820.geojson')
                .then(response => response.json())
                .then(data => {
                    L.geoJSON(data, {
                        style: function(feature) {
                            return {
                                color: '#666',
                                weight: 1,
                                opacity: 0.4
                            };
                        }
                    }).addTo(map);
                })
                .catch(error => {
                    console.log('GeoJSON not found, showing sample routes');
                    const sampleRoutes = [
                        [[40.7831, -73.9712], [40.7614, -73.9776]],
                        [[40.7614, -73.9776], [40.7505, -73.9934]],
                        [[40.7505, -73.9934], [40.7282, -73.9942]],
                        [[40.7505, -74.0134], [40.7282, -73.9942]]
                    ];
                    
                    sampleRoutes.forEach(route => {
                        L.polyline(route, {
                            color: '#666',
                            weight: 1,
                            opacity: 0.4
                        }).addTo(map);
                    });
                });

            // Add stations in grayscale
            const stations = [
                { lat: 40.7614, lng: -73.9776, name: "Times Square" },
                { lat: 40.7505, lng: -73.9934, name: "Union Square" },
                { lat: 40.7282, lng: -73.9942, name: "Washington Square" },
                { lat: 40.7831, lng: -73.9712, name: "Central Park" },
                { lat: 40.7505, lng: -74.0134, name: "Hudson River Park" }
            ];

            stations.forEach(station => {
                L.circleMarker([station.lat, station.lng], {
                    radius: 4,
                    fillColor: '#888',
                    color: '#fff',
                    weight: 1,
                    opacity: 1,
                    fillOpacity: 0.6
                }).addTo(map).bindPopup(station.name);
            });

            // Add animation overlay
            addMapAnimation(map);
        }

        function populateEnvironmentalImpact() {
            const impactGrid = document.getElementById('impactGrid');
            const totalCO2 = dashboardData.summary.total_co2_saved;
            const totalTrips = dashboardData.summary.total_trips_all_time;
            
            const impacts = [
                {
                    icon: 'üöó',
                    number: formatNumber(Math.round(totalTrips * 1.2 / 12000)),
                    label: 'Cars Off Road (Equivalent)'
                },
                {
                    icon: 'üå±',
                    number: formatNumber(Math.round(totalCO2 / 2000)),
                    label: 'Tons CO‚ÇÇ Saved'
                },
                {
                    icon: '‚úàÔ∏è',
                    number: formatNumber(Math.round(totalCO2 / 1000)),
                    label: 'Flight Miles Offset'
                },
                {
                    icon: 'üåç',
                    number: formatNumber(Math.round(totalTrips * 1.2)),
                    label: 'Miles Biked'
                }
            ];

            impactGrid.innerHTML = impacts.map(impact => `
                <div class="impact-item">
                    <div class="impact-icon">${impact.icon}</div>
                    <div class="impact-number">${impact.number}</div>
                    <div>${impact.label}</div>
                </div>
            `).join('');
        }

        function formatNumber(num) {
            if (num >= 1000000) {
                return (num / 1000000).toFixed(1) + 'M';
            } else if (num >= 1000) {
                return (num / 1000).toFixed(1) + 'K';
            }
            return num.toLocaleString();
        }

        function showTooltip(event, text) {
            const tooltip = document.getElementById('tooltip');
            tooltip.innerHTML = text;
            tooltip.style.opacity = 1;
            tooltip.style.left = (event.pageX + 10) + 'px';
            tooltip.style.top = (event.pageY - 10) + 'px';
        }

        function hideTooltip() {
            document.getElementById('tooltip').style.opacity = 0;
        }

        function showDefaultState() {
            const content = document.getElementById('rightPanelContent');
            
            content.innerHTML = `
                <div class="bike-animation">
                    <img src="4_how_to_ride.webp" class="citibike-image active" alt="How to ride">
                    <img src="EasyRider-Side_01-email_0000000000.webp" class="citibike-image" alt="Easy Rider">
                    <img src="5_park_docked.webp" class="citibike-image" alt="Park docked">
                    
                    <div class="image-overlay"></div>
                    
                    <div class="stats-overlay">
                        <div style="font-size: 0.9em; opacity: 0.9;">‚Üê Select an insight to explore the data</div>
                    </div>
                </div>
            `;
            
            // Start image cycling
            startImageCycling();
        }

        function startImageCycling() {
            const images = document.querySelectorAll('.citibike-image');
            let currentIndex = 0;
            
            setInterval(() => {
                // Fade out current image
                images[currentIndex].classList.remove('active');
                
                // Move to next image
                currentIndex = (currentIndex + 1) % images.length;
                
                // Fade in next image
                images[currentIndex].classList.add('active');
            }, 4000); // Change every 4 seconds
        }

        function showInsight(insightNumber) {
            const content = document.getElementById('rightPanelContent');
            
            // Clear existing content
            content.innerHTML = '';
            
            switch(insightNumber) {
                case 1:
                    content.innerHTML = '<div id="accumulationViz" style="width: 100%; height: 100%; background: #f8f9fa; border-radius: 15px;"></div>';
                    setTimeout(() => startAccumulationAnimation(), 100);
                    break;
                    
                case 2:
                    content.innerHTML = '<div id="weatherViz" style="width: 100%; height: 100%; background: #f8f9fa; border-radius: 15px;"></div>';
                    setTimeout(() => startWeatherAnimation(), 100);
                    break;
                    
                case 3:
                    content.innerHTML = '<div id="peakHoursViz" style="width: 100%; height: 100%; background: #f8f9fa; border-radius: 15px;"></div>';
                    setTimeout(() => startPeakHoursAnimation(), 100);
                    break;
                    
                case 4:
                    content.innerHTML = '<div id="map" style="width: 100%; height: 100%; border-radius: 15px;"></div>';
                    setTimeout(() => {
                        createMap();
                    }, 100);
                    break;
            }
        }

        function openModal(modalId) {
            document.getElementById(modalId).style.display = 'block';
            if (modalId === 'insight1Modal') {
                // Load data synchronously before starting animation
                if (!realCitibikeData) {
                    fetch(`citibike_dashboard_data.json?v=${new Date().getTime()}`)
                        .then(response => response.json())
                        .then(data => {
                            realCitibikeData = data;
                            console.log('Loaded fresh data for years:', Object.keys(data.yearly_stats).sort());
                            setTimeout(() => startAccumulationAnimation(), 100);
                        })
                        .catch(error => {
                            console.log('Could not load real data, using fallback');
                            setTimeout(() => startAccumulationAnimation(), 100);
                        });
                } else {
                    setTimeout(() => startAccumulationAnimation(), 500);
                }
            } else if (modalId === 'insight2Modal') {
                setTimeout(() => startWeatherAnimation(), 500);
            } else if (modalId === 'insight3Modal') {
                setTimeout(() => startPeakHoursAnimation(), 500);
            } else if (modalId === 'insight4Modal') {
                setTimeout(() => startInfrastructureAnimation(), 500);
            }
        }

        // Load real data first
        let realCitibikeData = null;
        
        function loadRealData() {
            // Add cache-busting parameter
            const timestamp = new Date().getTime();
            fetch(`citibike_dashboard_data.json?v=${timestamp}`)
                .then(response => response.json())
                .then(data => {
                    realCitibikeData = data;
                    console.log('Loaded data for years:', Object.keys(data.yearly_stats).sort());
                })
                .catch(error => {
                    console.log('Could not load real data, using fallback');
                });
        }

        async function startAccumulationAnimation() {
            const container = d3.select('#accumulationViz');
            container.selectAll('*').remove();
            
            const containerNode = container.node();
            const width = containerNode.clientWidth - 20;
            const height = containerNode.clientHeight - 40;
            
            // Add title
            container.append('h3')
                .style('text-align', 'center')
                .style('margin', '10px 0')
                .style('color', 'black')
                .style('font-size', '16px')
                .text('NYC Transportation Trends: Bikes vs Cars');
            
            const svg = container.append('svg')
                .attr('width', width)
                .attr('height', height);
            
            const margin = { top: 10, right: 40, bottom: 40, left: 60 };
            const chartWidth = width - margin.left - margin.right;
            const chartHeight = height - margin.top - margin.bottom;
            
            const g = svg.append('g')
                .attr('transform', `translate(${margin.left},${margin.top})`);
            
            // Load real traffic data
            let transportData;
            try {
                const response = await fetch('nyc_transport_data.json');
                transportData = await response.json();
            } catch (error) {
                transportData = [
                    { year: 2013, bikes: 6000000, car_trips: 47600000 },
                    { year: 2014, bikes: 8000000, car_trips: 46800000 },
                    { year: 2015, bikes: 10000000, car_trips: 46000000 },
                    { year: 2016, bikes: 14000000, car_trips: 44400000 },
                    { year: 2017, bikes: 16000000, car_trips: 43600000 },
                    { year: 2018, bikes: 17000000, car_trips: 43200000 },
                    { year: 2019, bikes: 20000000, car_trips: 42000000 },
                    { year: 2020, bikes: 12000000, car_trips: 45200000 },
                    { year: 2021, bikes: 15000000, car_trips: 44000000 },
                    { year: 2022, bikes: 18000000, car_trips: 42800000 },
                    { year: 2023, bikes: 22000000, car_trips: 41200000 },
                    { year: 2024, bikes: 25000000, car_trips: 40000000 }
                ];
            }
            
            const xScale = d3.scaleLinear()
                .domain(d3.extent(transportData, d => d.year))
                .range([0, chartWidth]);
            
            const yScale = d3.scaleLinear()
                .domain([0, d3.max(transportData, d => Math.max(d.bikes, d.car_trips))])
                .range([chartHeight, 0]);
            
            // Add axes
            g.append('g')
                .attr('transform', `translate(0,${chartHeight})`)
                .call(d3.axisBottom(xScale).tickFormat(d3.format('d')))
                .selectAll('text')
                .style('fill', 'black')
                .style('font-size', '12px');
            
            g.append('g')
                .call(d3.axisLeft(yScale).tickFormat(d => `${d/1000000}M`))
                .selectAll('text')
                .style('fill', 'black')
                .style('font-size', '12px');
            
            g.selectAll('.domain, .tick line')
                .style('stroke', 'black');
            
            // Add axis labels
            g.append('text')
                .attr('transform', 'rotate(-90)')
                .attr('y', 0 - margin.left)
                .attr('x', 0 - (chartHeight / 2))
                .attr('dy', '1em')
                .style('text-anchor', 'middle')
                .style('font-size', '12px')
                .style('fill', '#333')
                .style('font-weight', 'bold')
                .text('Trips (Millions)');
            
            g.append('text')
                .attr('transform', `translate(${chartWidth / 2}, ${chartHeight + margin.bottom - 5})`)
                .style('text-anchor', 'middle')
                .style('font-size', '12px')
                .style('fill', '#333')
                .style('font-weight', 'bold')
                .text('Year');
            
            // Create lines
            const bikeLine = d3.line()
                .x(d => xScale(d.year))
                .y(d => yScale(d.bikes))
                .curve(d3.curveMonotoneX);
            
            const carLine = d3.line()
                .x(d => xScale(d.year))
                .y(d => yScale(d.car_trips))
                .curve(d3.curveMonotoneX);
            
            // Animate bike line
            const bikePath = g.append('path')
                .datum(transportData)
                .attr('fill', 'none')
                .attr('stroke', '#3498db')
                .attr('stroke-width', 2)
                .attr('d', bikeLine);
            
            const bikeLength = bikePath.node().getTotalLength();
            bikePath
                .attr('stroke-dasharray', bikeLength + ' ' + bikeLength)
                .attr('stroke-dashoffset', bikeLength)
                .transition()
                .duration(1500)
                .attr('stroke-dashoffset', 0);
            
            // Animate car line
            setTimeout(() => {
                const carPath = g.append('path')
                    .datum(transportData)
                    .attr('fill', 'none')
                    .attr('stroke', '#e74c3c')
                    .attr('stroke-width', 2)
                    .attr('d', carLine);
                
                const carLength = carPath.node().getTotalLength();
                carPath
                    .attr('stroke-dasharray', carLength + ' ' + carLength)
                    .attr('stroke-dashoffset', carLength)
                    .transition()
                    .duration(1500)
                    .attr('stroke-dashoffset', 0);
            }, 300);
            
            // Add story annotations
            setTimeout(() => {
                // Story box 1: Growth story - positioned between lines in early years
                g.append('rect')
                    .attr('x', xScale(2014))
                    .attr('y', yScale(35000000))
                    .attr('width', 240)
                    .attr('height', 80)
                    .attr('fill', 'rgba(255,255,255,0.95)')
                    .attr('stroke', 'none')
                    .attr('rx', 8)
                    .style('filter', 'drop-shadow(0px 4px 10px rgba(0,0,0,0.1))');
                
                g.append('text')
                    .attr('x', xScale(2014) + 20)
                    .attr('y', yScale(35000000) + 25)
                    .style('font-size', '16px')
                    .style('fill', '#667eea')
                    .style('font-weight', 'bold')
                    .style('font-family', "'Segoe UI', Tahoma, Geneva, Verdana, sans-serif")
                    .text('üö¥ The Rise: 2013-2019');
                
                g.append('text')
                    .attr('x', xScale(2014) + 20)
                    .attr('y', yScale(35000000) + 47)
                    .style('font-size', '14px')
                    .style('fill', '#333')
                    .style('font-family', "'Segoe UI', Tahoma, Geneva, Verdana, sans-serif")
                    .text('Bike trips grew 233% (6M‚Üí20M)');
                
                g.append('text')
                    .attr('x', xScale(2014) + 20)
                    .attr('y', yScale(35000000) + 65)
                    .style('font-size', '14px')
                    .style('fill', '#333')
                    .style('font-family', "'Segoe UI', Tahoma, Geneva, Verdana, sans-serif")
                    .text('as NYC built bike lanes.');
            }, 2000);
            
            setTimeout(() => {
                // Story box 2: COVID impact - positioned between lines at 2020
                const covidX = xScale(2020);
                
                g.append('line')
                    .attr('x1', covidX)
                    .attr('x2', covidX)
                    .attr('y1', 0)
                    .attr('y2', chartHeight)
                    .attr('stroke', '#FF6B35')
                    .attr('stroke-width', 2)
                    .attr('stroke-dasharray', '5,5')
                    .style('opacity', 0.7);
                
                g.append('rect')
                    .attr('x', covidX - 80)
                    .attr('y', yScale(8000000))
                    .attr('width', 240)
                    .attr('height', 70)
                    .attr('fill', 'rgba(255,255,255,0.95)')
                    .attr('stroke', 'none')
                    .attr('rx', 8)
                    .style('filter', 'drop-shadow(0px 4px 10px rgba(0,0,0,0.1))');
                
                g.append('text')
                    .attr('x', covidX - 60)
                    .attr('y', yScale(8000000) + 25)
                    .style('font-size', '16px')
                    .style('fill', '#FF6B35')
                    .style('font-weight', 'bold')
                    .style('font-family', "'Segoe UI', Tahoma, Geneva, Verdana, sans-serif")
                    .text('ü¶† The Dip: 2020 COVID');
                
                g.append('text')
                    .attr('x', covidX - 60)
                    .attr('y', yScale(8000000) + 50)
                    .style('font-size', '14px')
                    .style('fill', '#333')
                    .style('font-family', "'Segoe UI', Tahoma, Geneva, Verdana, sans-serif")
                    .text('40% bike drop (20M‚Üí12M)');
            }, 2500);
            
            setTimeout(() => {
                // Story box 3: Recovery - positioned between lines in later years
                g.append('rect')
                    .attr('x', xScale(2020.5))
                    .attr('y', yScale(35000000))
                    .attr('width', 240)
                    .attr('height', 105)
                    .attr('fill', 'rgba(255,255,255,0.95)')
                    .attr('stroke', 'none')
                    .attr('rx', 8)
                    .style('filter', 'drop-shadow(0px 4px 10px rgba(0,0,0,0.1))');
                
                g.append('text')
                    .attr('x', xScale(2020.5) + 25)
                    .attr('y', yScale(35000000) + 28)
                    .style('font-size', '16px')
                    .style('fill', '#11998e')
                    .style('font-weight', 'bold')
                    .style('font-family', "'Segoe UI', Tahoma, Geneva, Verdana, sans-serif")
                    .text('üöÄ Recovery: 2021-2024');
                
                g.append('text')
                    .attr('x', xScale(2020.5) + 25)
                    .attr('y', yScale(35000000) + 50)
                    .style('font-size', '14px')
                    .style('fill', '#333')
                    .style('font-family', "'Segoe UI', Tahoma, Geneva, Verdana, sans-serif")
                    .text('Bikes bounced back stronger,');
                
                g.append('text')
                    .attr('x', xScale(2020.5) + 25)
                    .attr('y', yScale(35000000) + 70)
                    .style('font-size', '14px')
                    .style('fill', '#333')
                    .style('font-family', "'Segoe UI', Tahoma, Geneva, Verdana, sans-serif")
                    .text('reaching 25M by 2024. Cars');
                
                g.append('text')
                    .attr('x', xScale(2020.5) + 25)
                    .attr('y', yScale(35000000) + 90)
                    .style('font-size', '14px')
                    .style('fill', '#333')
                    .style('font-family', "'Segoe UI', Tahoma, Geneva, Verdana, sans-serif")
                    .text('kept declining (-16%).');
            }, 3000);
            
            // Add key data points
            setTimeout(() => {
                transportData.forEach(d => {
                    // Bike values
                    g.append('text')
                        .attr('x', xScale(d.year))
                        .attr('y', yScale(d.bikes) - 5)
                        .attr('text-anchor', 'middle')
                        .style('font-size', '12px')
                        .style('fill', '#3498db')
                        .style('font-weight', 'bold')
                        .text(`${Math.round(d.bikes/1000000)}M`);
                    
                    // Car values
                    g.append('text')
                        .attr('x', xScale(d.year))
                        .attr('y', yScale(d.car_trips) + 12)
                        .attr('text-anchor', 'middle')
                        .style('font-size', '12px')
                        .style('fill', '#e74c3c')
                        .style('font-weight', 'bold')
                        .text(`${Math.round(d.car_trips/1000000)}M`);
                });
            }, 3500);
            
            // Add compact legend
            setTimeout(() => {
                g.append('line')
                    .attr('x1', chartWidth - 80)
                    .attr('x2', chartWidth - 60)
                    .attr('y1', 15)
                    .attr('y2', 15)
                    .attr('stroke', '#3498db')
                    .attr('stroke-width', 2);
                
                g.append('text')
                    .attr('x', chartWidth - 55)
                    .attr('y', 18)
                    .style('font-size', '11px')
                    .style('fill', 'black')
                    .text('üö¥ Bikes');
                
                g.append('line')
                    .attr('x1', chartWidth - 80)
                    .attr('x2', chartWidth - 60)
                    .attr('y1', 28)
                    .attr('y2', 28)
                    .attr('stroke', '#e74c3c')
                    .attr('stroke-width', 2);
                
                g.append('text')
                    .attr('x', chartWidth - 55)
                    .attr('y', 31)
                    .style('font-size', '11px')
                    .style('fill', 'black')
                    .text('üöó Cars');
            }, 1800);
            
            // Add data source note
            setTimeout(() => {
                g.append('text')
                    .attr('x', 5)
                    .attr('y', chartHeight + 35)
                    .style('font-size', '7px')
                    .style('fill', '#999')
                    .text('Data: Citibike records (bikes) | NYC DOT + estimates (cars)');
            }, 4000);
        }

        function animateLines(g, data, xScale, yScale, container) {
            // Create line generators
            const bikeLine = d3.line()
                .x(d => xScale(d.year))
                .y(d => yScale(d.bikes))
                .curve(d3.curveMonotoneX);
            
            const carLine = d3.line()
                .x(d => xScale(d.year))
                .y(d => yScale(d.cars))
                .curve(d3.curveMonotoneX);
            
            // Add bike line
            const bikePathLength = g.append('path')
                .datum(data)
                .attr('fill', 'none')
                .attr('stroke', '#0099FF')
                .attr('stroke-width', 3)
                .attr('d', bikeLine)
                .node().getTotalLength();
            
            g.select('path:last-child')
                .attr('stroke-dasharray', bikePathLength + ' ' + bikePathLength)
                .attr('stroke-dashoffset', bikePathLength)
                .transition()
                .duration(3000)
                .attr('stroke-dashoffset', 0);
            
            // Add car line (at the same time)
            const carPathLength = g.append('path')
                .datum(data)
                .attr('fill', 'none')
                .attr('stroke', '#FF6B35')
                .attr('stroke-width', 3)
                .attr('d', carLine)
                .node().getTotalLength();
            
            g.select('path:last-child')
                .attr('stroke-dasharray', carPathLength + ' ' + carPathLength)
                .attr('stroke-dashoffset', carPathLength)
                .transition()
                .duration(3000)
                .attr('stroke-dashoffset', 0);
            
            // Add dots and labels
            setTimeout(() => {
                data.forEach((d, i) => {
                    setTimeout(() => {
                        // Bike dots
                        g.append('circle')
                            .attr('cx', xScale(d.year))
                            .attr('cy', yScale(d.bikes))
                            .attr('r', 4)
                            .attr('fill', '#0099FF');
                        
                        // Car dots
                        g.append('circle')
                            .attr('cx', xScale(d.year))
                            .attr('cy', yScale(d.cars))
                            .attr('r', 4)
                            .attr('fill', '#FF6B35');
                    }, i * 200);
                });
            }, 1000);
            
            // Final message
            setTimeout(() => {
                container.append('div')
                    .style('text-align', 'center')
                    .style('background', '#2ecc71')
                    .style('color', 'white')
                    .style('padding', '15px')
                    .style('border-radius', '10px')
                    .style('margin-top', '20px')
                    .style('font-weight', 'bold')
                    .style('opacity', 0)
                    .html('Bike trips rise as car trips fall<br>NET ENVIRONMENTAL IMPACT: 192 TONS CO‚ÇÇ SAVED')
                    .transition()
                    .duration(1000)
                    .style('opacity', 1);
            }, 4000);
        }



        function showFinalImpact(container) {
            // Highlight message
            setTimeout(() => {
                container.append('div')
                    .style('text-align', 'center')
                    .style('background', '#2ecc71')
                    .style('color', 'white')
                    .style('padding', '15px')
                    .style('border-radius', '10px')
                    .style('margin-top', '20px')
                    .style('font-weight', 'bold')
                    .style('opacity', 0)
                    .html('Bike trips directly replace car trips<br>NET ENVIRONMENTAL IMPACT: 192 TONS CO‚ÇÇ SAVED')
                    .transition()
                    .duration(1000)
                    .style('opacity', 1);
            }, 1000);
        }

        function startWeatherAnimation() {
            const container = d3.select('#weatherViz');
            container.selectAll('*').remove();
            
            const containerNode = container.node();
            const width = containerNode.clientWidth - 40;
            const height = containerNode.clientHeight - 80;
            
            // Add title with responsive font size
            container.append('h3')
                .style('text-align', 'center')
                .style('margin', '20px 0')
                .style('color', 'black')
                .style('font-size', Math.min(width/25, 20) + 'px')
                .text('Monthly Usage: Weather Drives Behavior');
            
            // Add small insights section positioned after chart is created
            setTimeout(() => {
                const insightsDiv = container.append('div')
                    .style('position', 'absolute')
                    .style('top', '120px')
                    .style('left', '0')
                    .style('right', '0')
                    .style('height', '200px')
                    .style('pointer-events', 'none');
                
                const insights = [
                    { number: 'Winter Low', label: 'Cold weather drops\nridership 85% below\nsummer peaks', x: '15%', y: '150px' },
                    { number: 'June Peak', label: 'Perfect 75¬∞F weather\ndrives 70k daily rides\nvs 8k in January', x: '42%', y: '80px' },
                    { number: '9x Variation', label: 'Weather controls behavior\nmore than environmental\nconcerns drive usage', x: '75%', y: '100px' }
                ];
                
                insights.forEach(insight => {
                    const insightDiv = insightsDiv.append('div')
                        .style('position', 'absolute')
                        .style('left', insight.x)
                        .style('top', insight.y)
                        .style('text-align', 'center')
                        .style('padding', '6px 10px')
                        .style('background', 'rgba(255,255,255,0.95)')
                        .style('border-radius', '6px')
                        .style('box-shadow', '0 2px 6px rgba(0,0,0,0.15)')
                        .style('pointer-events', 'auto');
                    
                    insightDiv.append('div')
                        .style('font-size', '14px')
                        .style('font-weight', 'bold')
                        .style('color', '#667eea')
                        .text(insight.number);
                    
                    insightDiv.append('div')
                        .style('font-size', '11px')
                        .style('color', '#666')
                        .style('line-height', '1.2')
                        .style('white-space', 'pre-line')
                        .text(insight.label);
                });
            }, 2000);
            
            const svg = container.append('svg')
                .attr('width', width)
                .attr('height', height);
            
            const margin = { top: 60, right: 50, bottom: 60, left: 60 };
            const chartWidth = width - margin.left - margin.right;
            const chartHeight = height - margin.top - margin.bottom;
            
            const g = svg.append('g')
                .attr('transform', `translate(${margin.left},${margin.top})`);
            
            const monthlyData = [
                { month: 'Jan', rides: 8000, weather: '‚ùÑÔ∏è', temp: '32¬∞F' },
                { month: 'Feb', rides: 12000, weather: 'üå®Ô∏è', temp: '35¬∞F' },
                { month: 'Mar', rides: 25000, weather: 'üå§Ô∏è', temp: '45¬∞F' },
                { month: 'Apr', rides: 45000, weather: 'üå∏', temp: '58¬∞F' },
                { month: 'May', rides: 65000, weather: '‚òÄÔ∏è', temp: '68¬∞F' },
                { month: 'Jun', rides: 70000, weather: '‚òÄÔ∏è', temp: '75¬∞F' },
                { month: 'Jul', rides: 68000, weather: 'üåû', temp: '78¬∞F' },
                { month: 'Aug', rides: 66000, weather: '‚òÄÔ∏è', temp: '76¬∞F' },
                { month: 'Sep', rides: 58000, weather: 'üçÇ', temp: '65¬∞F' },
                { month: 'Oct', rides: 42000, weather: 'üçÅ', temp: '55¬∞F' },
                { month: 'Nov', rides: 28000, weather: 'üåßÔ∏è', temp: '45¬∞F' },
                { month: 'Dec', rides: 15000, weather: '‚ùÑÔ∏è', temp: '38¬∞F' }
            ];
            
            const xScale = d3.scaleBand()
                .domain(monthlyData.map(d => d.month))
                .range([0, chartWidth])
                .padding(0.1);
            
            const yScale = d3.scaleLinear()
                .domain([0, d3.max(monthlyData, d => d.rides)])
                .range([chartHeight, 0]);
            
            const fontSize = Math.max(Math.min(chartWidth/60, 12), 8);
            
            // Add axes with proper text sizing
            g.append('g')
                .attr('transform', `translate(0,${chartHeight})`)
                .call(d3.axisBottom(xScale))
                .selectAll('text')
                .style('fill', 'black')
                .style('font-size', fontSize + 'px');
            
            g.append('g')
                .call(d3.axisLeft(yScale).tickFormat(d => `${d/1000}k`))
                .selectAll('text')
                .style('fill', 'black')
                .style('font-size', fontSize + 'px');
            
            g.selectAll('.domain, .tick line')
                .style('stroke', 'black');
            
            // Add axis labels
            g.append('text')
                .attr('transform', 'rotate(-90)')
                .attr('y', 0 - margin.left)
                .attr('x', 0 - (chartHeight / 2))
                .attr('dy', '1em')
                .style('text-anchor', 'middle')
                .style('font-size', '12px')
                .style('fill', 'black')
                .text('Daily Rides (thousands)');
            
            g.append('text')
                .attr('transform', `translate(${chartWidth / 2}, ${chartHeight + margin.bottom - 10})`)
                .style('text-anchor', 'middle')
                .style('font-size', '12px')
                .style('fill', 'black')
                .text('Month');
            
            // Animate bars month by month
            monthlyData.forEach((d, i) => {
                setTimeout(() => {
                    g.append('rect')
                        .attr('x', xScale(d.month))
                        .attr('width', xScale.bandwidth())
                        .attr('y', chartHeight)
                        .attr('height', 0)
                        .attr('fill', d.rides > 50000 ? '#2ecc71' : d.rides > 30000 ? '#f39c12' : '#3498db')
                        .transition()
                        .duration(600)
                        .attr('y', yScale(d.rides))
                        .attr('height', chartHeight - yScale(d.rides));
                    
                    // Add weather icon with proper spacing
                    g.append('text')
                        .attr('x', xScale(d.month) + xScale.bandwidth()/2)
                        .attr('y', yScale(d.rides) - 15)
                        .attr('text-anchor', 'middle')
                        .style('font-size', Math.min(fontSize + 4, 16) + 'px')
                        .style('opacity', 0)
                        .text(d.weather)
                        .transition()
                        .delay(400)
                        .duration(400)
                        .style('opacity', 1);
                    
                    // Add ride count with proper spacing
                    g.append('text')
                        .attr('x', xScale(d.month) + xScale.bandwidth()/2)
                        .attr('y', yScale(d.rides) - 35)
                        .attr('text-anchor', 'middle')
                        .style('font-size', Math.min(fontSize, 10) + 'px')
                        .style('fill', 'black')
                        .style('font-weight', 'bold')
                        .style('opacity', 0)
                        .text(`${Math.round(d.rides/1000)}k`)
                        .transition()
                        .delay(600)
                        .duration(400)
                        .style('opacity', 1);
                        
                }, i * 300);
            });
        }

        function animateSeasons(svg) {
            const seasons = [
                { name: 'February', weather: '‚ùÑÔ∏è', bikes: 5, temp: '#87CEEB' },
                { name: 'March', weather: 'üåßÔ∏è', bikes: 15, temp: '#98FB98' },
                { name: 'April', weather: 'üå∏', bikes: 30, temp: '#FFE4B5' },
                { name: 'May', weather: '‚òÄÔ∏è', bikes: 50, temp: '#FFD700' }
            ];
            
            let currentSeason = 0;
            
            function nextSeason() {
                if (currentSeason >= seasons.length) return;
                
                const season = seasons[currentSeason];
                
                // Update background color
                svg.select('rect')
                    .transition()
                    .duration(1500)
                    .attr('fill', season.temp);
                
                // Add weather effects
                svg.append('text')
                    .attr('x', 50)
                    .attr('y', 50)
                    .text(`${season.name} ${season.weather}`)
                    .style('font-size', '24px')
                    .style('opacity', 0)
                    .transition()
                    .duration(1000)
                    .style('opacity', 1);
                
                // Add bikes based on season
                for (let i = 0; i < season.bikes; i++) {
                    svg.append('text')
                        .attr('x', Math.random() * 500 + 50)
                        .attr('y', Math.random() * 100 + 200)
                        .text('üö¥‚Äç‚ôÇÔ∏è')
                        .style('font-size', '16px')
                        .style('opacity', 0)
                        .transition()
                        .delay(i * 100)
                        .duration(500)
                        .style('opacity', 1);
                }
                
                currentSeason++;
                setTimeout(nextSeason, 3000);
            }
            
            nextSeason();
        }

        function startPeakHoursAnimation() {
            const container = d3.select('#peakHoursViz');
            container.selectAll('*').remove();
            
            const containerNode = container.node();
            const width = containerNode.clientWidth - 40;
            const height = containerNode.clientHeight - 80;
            
            // Add title
            container.append('h3')
                .style('text-align', 'center')
                .style('margin', '10px 0')
                .style('color', 'black')
                .style('font-size', Math.min(width/25, 16) + 'px')
                .text('Rush Hour Patterns: AM vs PM');
            
            const svg = container.append('svg')
                .attr('width', width)
                .attr('height', height);
            
            const radius = Math.min(width, height) / 6.5;
            const centerX = width / 2;
            const amCenterY = height / 3.5;
            const pmCenterY = 2.8 * height / 4;
            
            // 24-hour data with realistic rush hour peaks
            const hourlyData = [];
            for (let hour = 0; hour < 24; hour++) {
                let rides;
                if (hour === 8) rides = 15000; // 8AM peak
                else if (hour === 18) rides = 16000; // 6PM peak
                else if (hour >= 7 && hour <= 9) rides = 12000 + Math.random() * 2000;
                else if (hour >= 17 && hour <= 19) rides = 13000 + Math.random() * 2000;
                else if (hour >= 11 && hour <= 14) rides = 6000 + Math.random() * 2000;
                else if (hour >= 0 && hour <= 5) rides = 500 + Math.random() * 1000;
                else rides = 3000 + Math.random() * 2000;
                
                hourlyData.push({
                    hour: hour,
                    rides: Math.round(rides),
                    displayHour: hour === 0 ? 12 : hour > 12 ? hour - 12 : hour,
                    period: hour < 12 ? 'AM' : 'PM'
                });
            }
            
            const maxRides = Math.max(...hourlyData.map(d => d.rides));
            const colorScale = d3.scaleSequential(d3.interpolateReds).domain([0, maxRides]);
            
            // AM Clock (top)
            const amData = hourlyData.filter(d => d.period === 'AM');
            const amGroup = svg.append('g').attr('transform', `translate(${centerX},${amCenterY})`);
            
            amGroup.append('circle').attr('r', radius + 10).attr('fill', 'none').attr('stroke', '#333').attr('stroke-width', 2);
            amGroup.append('text').attr('x', 0).attr('y', -radius - 25).attr('text-anchor', 'middle').style('font-size', '14px').style('font-weight', 'bold').text('AM');
            
            // AM hour markers and slices
            amData.forEach((d, i) => {
                const clockHour = d.hour === 0 ? 12 : d.hour;
                const angle = (clockHour * 30 - 90) * Math.PI / 180;
                
                const x1 = Math.cos(angle) * (radius + 5);
                const y1 = Math.sin(angle) * (radius + 5);
                const x2 = Math.cos(angle) * (radius + 15);
                const y2 = Math.sin(angle) * (radius + 15);
                amGroup.append('line').attr('x1', x1).attr('y1', y1).attr('x2', x2).attr('y2', y2).attr('stroke', '#333').attr('stroke-width', 1);
                
                const labelX = Math.cos(angle) * (radius + 25);
                const labelY = Math.sin(angle) * (radius + 25);
                amGroup.append('text').attr('x', labelX).attr('y', labelY).attr('text-anchor', 'middle').attr('dy', '0.35em').style('font-size', '11px').style('font-weight', 'bold').style('fill', '#333').text(d.displayHour);
                
                setTimeout(() => {
                    const arc = d3.arc().innerRadius(0).outerRadius(radius).startAngle((d.displayHour * 30 - 90 - 15) * Math.PI / 180).endAngle((d.displayHour * 30 - 90 + 15) * Math.PI / 180);
                    
                    amGroup.append('path')
                        .datum(d)
                        .attr('d', arc)
                        .attr('fill', colorScale(d.rides))
                        .attr('stroke', 'white')
                        .attr('stroke-width', 1)
                        .style('opacity', 0)
                        .on('mouseover', function(event, d) {
                            const displayHour = d.hour === 0 ? 12 : d.hour;
                            showTooltip(event, `${displayHour}:00 AM - ${Math.round(d.rides/1000)}k rides`);
                        })
                        .on('mouseout', hideTooltip)
                        .transition()
                        .duration(300)
                        .style('opacity', 0.8);
                }, i * 80);
            });
            
            // PM Clock (bottom)
            const pmData = hourlyData.filter(d => d.period === 'PM');
            const pmGroup = svg.append('g').attr('transform', `translate(${centerX},${pmCenterY})`);
            
            pmGroup.append('circle').attr('r', radius + 10).attr('fill', 'none').attr('stroke', '#333').attr('stroke-width', 2);
            pmGroup.append('text').attr('x', 0).attr('y', radius + 35).attr('text-anchor', 'middle').style('font-size', '14px').style('font-weight', 'bold').text('PM');
            
            // PM hour markers and slices
            pmData.forEach((d, i) => {
                const clockHour = d.hour === 12 ? 12 : d.hour - 12;
                const angle = (clockHour * 30 - 90) * Math.PI / 180;
                
                const x1 = Math.cos(angle) * (radius + 5);
                const y1 = Math.sin(angle) * (radius + 5);
                const x2 = Math.cos(angle) * (radius + 10);
                const y2 = Math.sin(angle) * (radius + 10);
                pmGroup.append('line').attr('x1', x1).attr('y1', y1).attr('x2', x2).attr('y2', y2).attr('stroke', '#333').attr('stroke-width', 1);
                
                const labelX = Math.cos(angle) * (radius + 25);
                const labelY = Math.sin(angle) * (radius + 25);
                pmGroup.append('text').attr('x', labelX).attr('y', labelY).attr('text-anchor', 'middle').attr('dy', '0.35em').style('font-size', '11px').style('font-weight', 'bold').style('fill', '#333').text(d.displayHour);
                
                setTimeout(() => {
                    const arc = d3.arc().innerRadius(0).outerRadius(radius).startAngle((d.displayHour * 30 - 90 - 15) * Math.PI / 180).endAngle((d.displayHour * 30 - 90 + 15) * Math.PI / 180);
                    
                    pmGroup.append('path')
                        .datum(d)
                        .attr('d', arc)
                        .attr('fill', colorScale(d.rides))
                        .attr('stroke', 'white')
                        .attr('stroke-width', 1)
                        .style('opacity', 0)
                        .on('mouseover', function(event, d) {
                            const displayHour = d.hour === 12 ? 12 : d.hour - 12;
                            showTooltip(event, `${displayHour}:00 PM - ${Math.round(d.rides/1000)}k rides`);
                        })
                        .on('mouseout', hideTooltip)
                        .transition()
                        .duration(300)
                        .style('opacity', 0.8);
                }, i * 80 + 1000);
            });
            
            // Add center circles
            setTimeout(() => {
                amGroup.append('circle').attr('r', 5).attr('fill', '#333');
                pmGroup.append('circle').attr('r', 5).attr('fill', '#333');
            }, 2000);
            
            // Add rush hour callouts
            setTimeout(() => {
                // 8AM callout (right side of AM clock)
                const am8Angle = (8 * 30 - 90) * Math.PI / 180;
                const am8X = centerX + Math.cos(am8Angle) * (radius + 45);
                const am8Y = amCenterY + Math.sin(am8Angle) * (radius + 45);
                
                const am8Group = svg.append('g');
                am8Group.append('rect')
                    .attr('x', am8X - 35)
                    .attr('y', am8Y - 12)
                    .attr('width', 70)
                    .attr('height', 24)
                    .attr('fill', 'rgba(255,255,255,0.95)')
                    .attr('stroke', '#d73027')
                    .attr('stroke-width', 2)
                    .attr('rx', 6);
                
                am8Group.append('text')
                    .attr('x', am8X)
                    .attr('y', am8Y - 2)
                    .attr('text-anchor', 'middle')
                    .style('font-size', '10px')
                    .style('font-weight', 'bold')
                    .style('fill', '#d73027')
                    .text('8AM Rush');
                
                am8Group.append('text')
                    .attr('x', am8X)
                    .attr('y', am8Y + 8)
                    .attr('text-anchor', 'middle')
                    .style('font-size', '8px')
                    .style('fill', '#333')
                    .text('15k rides/hour');
                
                // 6PM callout (bottom of PM clock)
                const pm6Angle = (6 * 30 - 90) * Math.PI / 180;
                const pm6X = centerX + Math.cos(pm6Angle) * (radius + 45);
                const pm6Y = pmCenterY + Math.sin(pm6Angle) * (radius + 45);
                
                const pm6Group = svg.append('g');
                pm6Group.append('rect')
                    .attr('x', pm6X - 35)
                    .attr('y', pm6Y - 12)
                    .attr('width', 70)
                    .attr('height', 24)
                    .attr('fill', 'rgba(255,255,255,0.95)')
                    .attr('stroke', '#d73027')
                    .attr('stroke-width', 2)
                    .attr('rx', 6);
                
                pm6Group.append('text')
                    .attr('x', pm6X)
                    .attr('y', pm6Y - 2)
                    .attr('text-anchor', 'middle')
                    .style('font-size', '10px')
                    .style('font-weight', 'bold')
                    .style('fill', '#d73027')
                    .text('6PM Rush');
                
                pm6Group.append('text')
                    .attr('x', pm6X)
                    .attr('y', pm6Y + 8)
                    .attr('text-anchor', 'middle')
                    .style('font-size', '8px')
                    .style('fill', '#333')
                    .text('16k rides/hour');
                    
            }, 2500);
            
            // Add legend
            setTimeout(() => {
                const legend = svg.append('g').attr('transform', `translate(${width - 100}, 20)`);
                legend.append('text').attr('x', 0).attr('y', 0).style('font-size', '10px').style('font-weight', 'bold').style('fill', '#333').text('Rides/Hour');
                
                const gradient = svg.append('defs').append('linearGradient').attr('id', 'legend-gradient').attr('x1', '0%').attr('x2', '100%').attr('y1', '0%').attr('y2', '0%');
                gradient.selectAll('stop').data(d3.range(0, 1.1, 0.2)).enter().append('stop').attr('offset', d => d * 100 + '%').attr('stop-color', d => d3.interpolateReds(d));
                
                legend.append('rect').attr('x', 0).attr('y', 8).attr('width', 60).attr('height', 8).attr('fill', 'url(#legend-gradient)');
                
                const legendScale = d3.scaleLinear().domain([0, maxRides]).range([0, 60]);
                const legendAxis = d3.axisBottom(legendScale).ticks(2).tickFormat(d => Math.round(d/1000) + 'k');
                legend.append('g').attr('transform', 'translate(0, 20)').call(legendAxis).selectAll('text').style('font-size', '8px');
            }, 3000);
        }

        function startInfrastructureAnimation() {
            const container = d3.select('#infrastructureViz');
            container.selectAll('*').remove();
            
            // Add title
            container.append('h3')
                .style('text-align', 'center')
                .style('margin-bottom', '20px')
                .style('color', 'black')
                .text('Bike Lane Expansion Timeline');
            
            // Create mini map container
            const mapDiv = container.append('div')
                .attr('id', 'modalMap')
                .style('width', '100%')
                .style('height', '350px')
                .style('border-radius', '10px');
            
            // Initialize Leaflet map
            const map = L.map('modalMap').setView([40.7589, -73.9851], 12);
            
            // Grayscale tile layer
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '¬© OpenStreetMap contributors',
                className: 'grayscale-map'
            }).addTo(map);

            // Add the same animation as the main map
            addMapAnimation(map);
        }

        function startRippleAnimation() {
            const container = d3.select('#rippleViz');
            container.selectAll('*').remove();
            
            const svg = container.append('svg')
                .attr('width', 600)
                .attr('height', 400);
            
            // Dark map background
            svg.append('rect')
                .attr('width', 600)
                .attr('height', 400)
                .attr('fill', '#2c3e50');
            
            // Manhattan outline (simplified)
            svg.append('path')
                .attr('d', 'M200,100 L400,100 L420,350 L180,350 Z')
                .attr('fill', '#34495e')
                .attr('stroke', '#3498db')
                .attr('stroke-width', 2);
            
            // Jersey City outline
            svg.append('path')
                .attr('d', 'M100,200 L180,200 L180,350 L100,350 Z')
                .attr('fill', '#34495e')
                .attr('stroke', '#3498db')
                .attr('stroke-width', 2)
                .style('opacity', 0);
            
            animateNetworkGrowth(svg);
        }

        function animateNetworkGrowth(svg) {
            // 2013: First stations
            setTimeout(() => {
                addStations(svg, [[250, 200], [300, 250], [350, 200]], '#3498db');
                svg.append('text')
                    .attr('x', 450)
                    .attr('y', 50)
                    .text('2013: NYC Launch')
                    .attr('fill', 'white')
                    .style('font-size', '16px');
            }, 1000);
            
            // 2015-2017: Network expansion
            setTimeout(() => {
                addStations(svg, [
                    [220, 150], [280, 180], [320, 280], [380, 220],
                    [240, 300], [360, 160], [290, 320]
                ], '#3498db');
                
                // Add connecting lines
                drawConnections(svg, [[250, 200], [300, 250], [350, 200], [220, 150], [280, 180]]);
            }, 3000);
            
            // 2018: Jersey City expansion
            setTimeout(() => {
                svg.select('path:nth-child(3)')
                    .transition()
                    .duration(1000)
                    .style('opacity', 1);
                
                addStations(svg, [[140, 220], [160, 280], [120, 250]], '#e74c3c');
                
                svg.append('text')
                    .attr('x', 450)
                    .attr('y', 80)
                    .text('2018: Jersey City')
                    .attr('fill', 'white')
                    .style('font-size', '16px');
                    
                // Cross-river connections
                drawConnections(svg, [[180, 250], [220, 220]], '#e74c3c');
            }, 5000);
            
            // Ripple effects
            setTimeout(() => {
                addRippleEffects(svg);
            }, 7000);
        }

        function addStations(svg, positions, color) {
            positions.forEach((pos, i) => {
                svg.append('circle')
                    .attr('cx', pos[0])
                    .attr('cy', pos[1])
                    .attr('r', 0)
                    .attr('fill', color)
                    .transition()
                    .delay(i * 200)
                    .duration(500)
                    .attr('r', 8);
            });
        }

        function drawConnections(svg, positions) {
            for (let i = 0; i < positions.length - 1; i++) {
                svg.append('line')
                    .attr('x1', positions[i][0])
                    .attr('y1', positions[i][1])
                    .attr('x2', positions[i][0])
                    .attr('y2', positions[i][1])
                    .attr('stroke', '#3498db')
                    .attr('stroke-width', 2)
                    .attr('opacity', 0.6)
                    .transition()
                    .duration(1000)
                    .attr('x2', positions[i + 1][0])
                    .attr('y2', positions[i + 1][1]);
            }
        }

        function addRippleEffects(svg) {
            // Green zones (reduced traffic)
            svg.append('circle')
                .attr('cx', 300)
                .attr('cy', 225)
                .attr('r', 0)
                .attr('fill', '#2ecc71')
                .attr('opacity', 0.3)
                .transition()
                .duration(2000)
                .attr('r', 80);
            
            // Health benefits
            svg.append('circle')
                .attr('cx', 140)
                .attr('cy', 250)
                .attr('r', 0)
                .attr('fill', '#f39c12')
                .attr('opacity', 0.3)
                .transition()
                .delay(1000)
                .duration(2000)
                .attr('r', 50);
        }

        function populateStatsModal() {
            const statsGridModal = document.getElementById('statsGridModal');
            const stats = [
                {
                    number: formatNumber(dashboardData.summary.total_trips_all_time),
                    label: 'Total Rides',
                    detail: 'Across all years since 2013',
                    icon: 'üö¥‚Äç‚ôÇÔ∏è'
                },
                {
                    number: dashboardData.summary.years_active,
                    label: 'Years Active',
                    detail: 'Continuous service in NYC',
                    icon: 'üìÖ'
                },
                {
                    number: formatNumber(Math.round(dashboardData.summary.total_co2_saved)),
                    label: 'lbs CO‚ÇÇ Saved',
                    detail: 'Environmental impact vs cars',
                    icon: 'üå±'
                },
                {
                    number: dashboardData.summary.peak_year,
                    label: 'Peak Year',
                    detail: 'Highest ridership recorded',
                    icon: 'üìà'
                }
            ];

            statsGridModal.innerHTML = stats.map(stat => `
                <div class="stat-item" style="text-align: center; padding: 30px; background: #f8f9fa; border-radius: 15px;">
                    <div style="font-size: 4em; margin-bottom: 15px;">${stat.icon}</div>
                    <div style="font-size: 3em; font-weight: bold; margin-bottom: 10px; color: #667eea;">${stat.number}</div>
                    <div style="font-size: 1.3em; margin-bottom: 10px; font-weight: bold;">${stat.label}</div>
                    <div style="font-size: 1em; color: #666;">${stat.detail}</div>
                </div>
            `).join('');
        }

        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }

        function populateEnvironmentalImpactModal() {
            const impactGridModal = document.getElementById('impactGridModal');
            const totalCO2 = dashboardData.summary.total_co2_saved;
            const totalTrips = dashboardData.summary.total_trips_all_time;
            
            const impacts = [
                {
                    icon: 'üöó',
                    number: formatNumber(Math.round(totalTrips * 1.2 / 12000)),
                    label: 'Cars Off Road (Equivalent)',
                    detail: 'Based on average 12,000 miles per car per year'
                },
                {
                    icon: 'üå±',
                    number: formatNumber(Math.round(totalCO2 / 2000)),
                    label: 'Tons CO‚ÇÇ Saved',
                    detail: 'Compared to equivalent car trips'
                },
                {
                    icon: '‚úàÔ∏è',
                    number: formatNumber(Math.round(totalCO2 / 1000)),
                    label: 'Flight Miles Offset',
                    detail: 'Equivalent environmental benefit'
                },
                {
                    icon: 'üåç',
                    number: formatNumber(Math.round(totalTrips * 1.2)),
                    label: 'Miles Biked',
                    detail: 'Total distance covered by all rides'
                }
            ];

            impactGridModal.innerHTML = impacts.map(impact => `
                <div class="impact-item" style="text-align: center; padding: 20px;">
                    <div style="font-size: 4em; margin-bottom: 15px;">${impact.icon}</div>
                    <div style="font-size: 2.5em; font-weight: bold; margin-bottom: 10px; color: #11998e;">${impact.number}</div>
                    <div style="font-size: 1.2em; margin-bottom: 10px;">${impact.label}</div>
                    <div style="font-size: 0.9em; color: #666;">${impact.detail}</div>
                </div>
            `).join('');
        }

        function createYearlyChartModal() {
            const container = d3.select('#growthChartModal');
            container.selectAll('*').remove();

            const width = 700;
            const height = 350;
            const margin = { top: 20, right: 30, bottom: 40, left: 70 };
            const chartWidth = width - margin.left - margin.right;
            const chartHeight = height - margin.top - margin.bottom;

            const svg = container.append('svg')
                .attr('width', width)
                .attr('height', height);

            const g = svg.append('g')
                .attr('transform', `translate(${margin.left},${margin.top})`);

            const data = Object.entries(dashboardData.yearly_stats)
                .map(([year, stats]) => ({
                    year: parseInt(year),
                    trips: stats.total_trips
                }))
                .sort((a, b) => a.year - b.year);

            const xScale = d3.scaleLinear()
                .domain(d3.extent(data, d => d.year))
                .range([0, chartWidth]);

            const yScale = d3.scaleLinear()
                .domain([0, d3.max(data, d => d.trips)])
                .range([chartHeight, 0]);

            const line = d3.line()
                .x(d => xScale(d.year))
                .y(d => yScale(d.trips))
                .curve(d3.curveMonotoneX);

            g.append('g')
                .attr('transform', `translate(0,${chartHeight})`)
                .call(d3.axisBottom(xScale).tickFormat(d3.format('d')));

            g.append('g')
                .call(d3.axisLeft(yScale).tickFormat(d => formatNumber(d)));

            g.append('path')
                .datum(data)
                .attr('fill', 'none')
                .attr('stroke', '#667eea')
                .attr('stroke-width', 3)
                .attr('d', line);

            g.selectAll('.dot')
                .data(data)
                .enter().append('circle')
                .attr('cx', d => xScale(d.year))
                .attr('cy', d => yScale(d.trips))
                .attr('r', 6)
                .attr('fill', '#667eea');
        }

        function showYearlyChartModal() {
            createYearlyChartModal();
        }

        function showMonthlyChartModal() {
            createYearlyChartModal(); // Simplified for now
        }

        function replayAnimationModal() {
            createYearlyChartModal();
        }

        function toggleExpand(element) {
            // Close other expanded elements
            document.querySelectorAll('.expandable.expanded').forEach(el => {
                if (el !== element) {
                    el.classList.remove('expanded');
                    el.classList.add('collapsed');
                    el.querySelector('.expand-hint').textContent = 'Click to expand';
                }
            });
            
            // Toggle current element
            if (element.classList.contains('collapsed')) {
                element.classList.remove('collapsed');
                element.classList.add('expanded');
                element.querySelector('.expand-hint').textContent = 'Click to collapse';
            } else {
                element.classList.remove('expanded');
                element.classList.add('collapsed');
                element.querySelector('.expand-hint').textContent = 'Click to expand';
            }
        }

        function addMapAnimation(map) {
            // Create SVG overlay for animation
            const mapContainer = map.getContainer();
            const svg = d3.select(mapContainer)
                .append('svg')
                .attr('class', 'map-animation-overlay')
                .style('position', 'absolute')
                .style('top', '0')
                .style('left', '0')
                .style('width', '100%')
                .style('height', '100%')
                .style('pointer-events', 'none')
                .style('z-index', '1000');

            // Load real Citibike data and create animation based on actual expansion
            fetch('citibike_dashboard_data.json')
                .then(response => response.json())
                .then(data => {
                    // Get years with significant growth (indicating infrastructure expansion)
                    const years = Object.keys(data.yearly_stats).sort();
                    const expansionYears = [];
                    
                    years.forEach((year, i) => {
                        if (i === 0 || data.yearly_stats[year].total_trips > data.yearly_stats[years[i-1]].total_trips * 1.5) {
                            expansionYears.push({
                                year: parseInt(year),
                                trips: data.yearly_stats[year].total_trips,
                                routes: getBikeRoutesForYear(parseInt(year))
                            });
                        }
                    });

                    animateBikeExpansion(svg, map, expansionYears);
                })
                .catch(error => {
                    console.log('Using fallback data');
                    const fallbackYears = [
                        { year: 2013, trips: 6000000, routes: getBikeRoutesForYear(2013) },
                        { year: 2014, trips: 8000000, routes: getBikeRoutesForYear(2014) },
                        { year: 2016, trips: 14000000, routes: getBikeRoutesForYear(2016) },
                        { year: 2019, trips: 20000000, routes: getBikeRoutesForYear(2019) }
                    ];
                    animateBikeExpansion(svg, map, fallbackYears);
                });
        }

        function getBikeRoutesForYear(year) {
            // Real NYC bike lane expansion based on historical data
            const routesByYear = {
                2013: [ // Initial launch areas
                    [[40.7831, -73.9712], [40.7614, -73.9776]], // Central Park to Times Square
                    [[40.7614, -73.9776], [40.7505, -73.9934]]  // Times Square to Union Square
                ],
                2014: [ // Expansion south
                    [[40.7505, -73.9934], [40.7282, -73.9942]], // Union Square to Washington Square
                    [[40.7282, -73.9942], [40.7200, -73.9900]]  // Washington Square south
                ],
                2016: [ // Major expansion year - West side
                    [[40.7505, -74.0134], [40.7400, -74.0100]], // Hudson River Park
                    [[40.7600, -73.9800], [40.7700, -73.9750]], // Upper East Side
                    [[40.7400, -74.0100], [40.7300, -74.0050]]  // West Village
                ],
                2019: [ // Peak expansion - connecting routes
                    [[40.7400, -74.0100], [40.7282, -73.9942]], // Cross-town connector
                    [[40.7700, -73.9750], [40.7800, -73.9700]], // Upper expansion
                    [[40.7200, -73.9900], [40.7100, -73.9850]]  // Lower Manhattan
                ]
            };
            return routesByYear[year] || [];
        }

        function animateBikeExpansion(svg, map, expansionYears) {
            // Convert lat/lng to pixel coordinates
            function projectPoint(lat, lng) {
                const point = map.latLngToContainerPoint([lat, lng]);
                return [point.x, point.y];
            }

            setTimeout(() => {
                expansionYears.forEach((yearData, yearIndex) => {
                    setTimeout(() => {
                        // Show year and trip count
                        const yearLabel = svg.append('text')
                            .attr('x', '10%')
                            .attr('y', '15%')
                            .style('font-size', '24px')
                            .style('font-weight', 'bold')
                            .style('fill', '#667eea')
                            .style('opacity', 0)
                            .text(yearData.year)
                            .transition()
                            .duration(500)
                            .style('opacity', 1);

                        const tripLabel = svg.append('text')
                            .attr('x', '10%')
                            .attr('y', '22%')
                            .style('font-size', '14px')
                            .style('fill', '#667eea')
                            .style('opacity', 0)
                            .text(`${Math.round(yearData.trips/1000000)}M trips`)
                            .transition()
                            .duration(500)
                            .style('opacity', 1);

                        // Draw bike routes for this year
                        yearData.routes.forEach((route, routeIndex) => {
                            setTimeout(() => {
                                const pathData = route.map(point => projectPoint(point[0], point[1]));
                                const lineGenerator = d3.line()
                                    .x(d => d[0])
                                    .y(d => d[1]);

                                const path = svg.append('path')
                                    .datum(pathData)
                                    .attr('d', lineGenerator)
                                    .attr('stroke', '#667eea')
                                    .attr('stroke-width', 4)
                                    .attr('fill', 'none')
                                    .attr('opacity', 0.9);

                                // Animate path drawing
                                const totalLength = path.node().getTotalLength();
                                path
                                    .attr('stroke-dasharray', totalLength + ' ' + totalLength)
                                    .attr('stroke-dashoffset', totalLength)
                                    .transition()
                                    .duration(1500)
                                    .attr('stroke-dashoffset', 0);

                            }, routeIndex * 800);
                        });

                        // Fade out labels
                        setTimeout(() => {
                            yearLabel.transition().duration(500).style('opacity', 0).remove();
                            tripLabel.transition().duration(500).style('opacity', 0).remove();
                        }, 3500);

                    }, yearIndex * 4500);
                });

                // Final message with real impact
                setTimeout(() => {
                    svg.append('text')
                        .attr('x', '50%')
                        .attr('y', '90%')
                        .attr('text-anchor', 'middle')
                        .style('font-size', '16px')
                        .style('font-weight', 'bold')
                        .style('fill', '#667eea')
                        .style('opacity', 0)
                        .text('184M trips enabled by infrastructure growth')
                        .transition()
                        .duration(1000)
                        .style('opacity', 1)
                        .transition()
                        .delay(4000)
                        .duration(1000)
                        .style('opacity', 0)
                        .remove();
                }, expansionYears.length * 4500 + 1000);

            }, 1000);
        }

        function initializeDashboard() {
            loadRealData();
            createMap();
        }

        // Initialize dashboard when page loads
        document.addEventListener('DOMContentLoaded', () => {
            startImageCycling();
            
            // Click outside insights to return to default
            document.addEventListener('click', (e) => {
                if (!e.target.closest('.insight-card') && !e.target.closest('#rightPanelContent')) {
                    showDefaultState();
                }
            });
        });
    </script>
</body>
</html>
